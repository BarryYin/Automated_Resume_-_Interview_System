<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR管理控制台</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/pdf-viewer.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- 头部 -->
        <div class="dashboard-header">
            <div class="header-left">
                <button class="back-btn" onclick="goHome()">← 返回首页</button>
                <h1>HR 管理控制台</h1>
            </div>
            <div class="header-right">
                <button class="logout-btn" onclick="adminLogout()">退出登录</button>
            </div>
        </div>
        
        <!-- 导航标签 -->
        <div class="dashboard-nav">
            <button class="nav-btn active" data-tab="positions" onclick="switchTab('positions')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
                岗位管理
            </button>
            <button class="nav-btn" data-tab="candidates" onclick="switchTab('candidates')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A3.01 3.01 0 0 0 17.1 7H16c-.8 0-1.54.37-2.03.97L12 10l-1.97-2.03A2.99 2.99 0 0 0 8 7H6.9c-1.3 0-2.44.84-2.86 2.37L1.5 16H4v6h2v-6h2.5l2.5-3 2.5 3H16v6h4z"/>
                </svg>
                候选人
            </button>
            <button class="nav-btn" data-tab="analytics" onclick="switchTab('analytics')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                </svg>
                数据分析
            </button>
        </div>
        
        <!-- 岗位管理内容 -->
        <div id="positions-content" class="tab-content active">
            <div class="content-header">
                <div class="header-title">
                    <h2>招聘岗位列表</h2>
                    <p class="content-subtitle">管理所有招聘岗位和候选人</p>
                </div>
                <button class="create-btn" id="createPositionBtn" onclick="createNewPosition()">+ 创建新职位</button>
            </div>
            
            <div class="positions-list">
                <div class="position-card">
                    <div class="position-header">
                        <div class="position-info">
                            <h3>高级前端工程师</h3>
                            <span class="position-status recruiting">招聘中</span>
                        </div>
                        <div class="position-actions">
                            <button class="action-btn view" onclick="viewPosition('frontend')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                查看
                            </button>
                            <button class="action-btn edit" onclick="editPosition('frontend')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                            <button class="action-btn delete" onclick="deletePosition('frontend')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="position-details">
                        <div class="detail-item">
                            <span class="label">技术部</span>
                            <span class="value">薪资: ¥20,000 - ¥35,000</span>
                            <span class="value">12 位候选人</span>
                            <span class="value">发布于 2025-01-15</span>
                        </div>
                    </div>
                </div>
                
                <div class="position-card">
                    <div class="position-header">
                        <div class="position-info">
                            <h3>产品经理</h3>
                            <span class="position-status recruiting">招聘中</span>
                        </div>
                        <div class="position-actions">
                            <button class="action-btn view" onclick="viewPosition('pm')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                查看
                            </button>
                            <button class="action-btn edit" onclick="editPosition('pm')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                            <button class="action-btn delete" onclick="deletePosition('pm')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="position-details">
                        <div class="detail-item">
                            <span class="label">产品部</span>
                            <span class="value">薪资: ¥18,000 - ¥30,000</span>
                            <span class="value">8 位候选人</span>
                            <span class="value">发布于 2025-01-20</span>
                        </div>
                    </div>
                </div>
                
                <div class="position-card">
                    <div class="position-header">
                        <div class="position-info">
                            <h3>Python工程师服务器端开发</h3>
                            <span class="position-status recruiting">招聘中</span>
                        </div>
                        <div class="position-actions">
                            <button class="action-btn view" onclick="viewPosition('python')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                查看
                            </button>
                            <button class="action-btn edit" onclick="editPosition('python')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                            <button class="action-btn delete" onclick="deletePosition('python')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="position-details">
                        <div class="detail-item">
                            <span class="label">技术部</span>
                            <span class="value">薪资: ¥15,000 - ¥25,000</span>
                            <span class="value">6 位候选人</span>
                            <span class="value">发布于 2025-01-18</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 候选人内容 -->
        <div id="candidates-content" class="tab-content">
            <div class="content-header">
                <div class="header-title">
                    <h2>候选人列表</h2>
                    <p class="content-subtitle">查看所有候选人的面试情况和评分</p>
                </div>
                <button class="create-btn" id="addCandidateBtn" onclick="addCandidate()">+ 添加候选人</button>
            </div>
            
            <div class="content-body">
                <div class="search-filter">
                    <div class="search-box">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="text" placeholder="搜索候选人姓名或邮箱..." id="candidateSearch">
                    </div>
                    <select class="filter-select" id="statusFilter">
                        <option value="all">全部状态</option>
                        <option value="completed">已完成</option>
                        <option value="in-progress">面试中</option>
                        <option value="pending">待面试</option>
                    </select>
                </div>
                
                <div class="candidates-list">
                    <!-- 候选人数据将通过JavaScript动态加载 -->
                    <div class="loading-message">正在加载候选人数据...</div>
                </div>
            </div>
        </div>
        
        <!-- 数据分析内容 -->
        <div id="analytics-content" class="tab-content">
            <!-- 统计卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">📋</div>
                    <div class="stat-content">
                        <div class="stat-number" id="analyticsActivePositions">12</div>
                        <div class="stat-label">活跃职位</div>
                        <div class="stat-change">较上月 +2</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-content">
                        <div class="stat-number" id="analyticsTotalCandidates">156</div>
                        <div class="stat-label">总候选人</div>
                        <div class="stat-change">较上月 +23</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">✅</div>
                    <div class="stat-content">
                        <div class="stat-number" id="analyticsCompletedInterviews">89</div>
                        <div class="stat-label">已完成面试</div>
                        <div class="stat-change">完成率 57%</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-content">
                        <div class="stat-number" id="analyticsAverageScore">78.5</div>
                        <div class="stat-label">平均得分</div>
                        <div class="stat-change">较上月 +3.2</div>
                    </div>
                </div>
            </div>

            <!-- 分析内容区域 -->
            <div class="analytics-main">
                <!-- 最近两天最符合的候选人 -->
                <div class="analytics-section">
                    <h2>最近两天最符合的候选人</h2>
                    <p class="section-subtitle">根据 AI 评分和匹配度排序</p>
                    
                    <div class="candidates-ranking">
                        <!-- 动态加载的最佳候选人数据 -->
                        <div class="loading-message">正在加载最佳候选人数据...</div>
                    </div>
                </div>

                <!-- 薪资要求最低的候选人 -->
                <div class="analytics-section">
                    <h2>薪资要求最低的候选人</h2>
                    <p class="section-subtitle">按岗位分类显示</p>
                    
                    <div class="salary-ranking">
                        <!-- 动态加载的最低薪资候选人数据 -->
                        <div class="loading-message">正在加载最低薪资候选人数据...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 智能对话按钮 -->
        <div class="chat-fab" onclick="toggleAIChat()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
        </div>

        <!-- AI对话侧边栏 -->
        <div class="ai-chat-sidebar" id="aiChatSidebar">
            <div class="chat-header">
                <h3>AI数据分析助手</h3>
                <button class="close-chat" onclick="toggleAIChat()">×</button>
            </div>
            <div class="chat-messages" id="aiChatMessages">
                <div class="ai-message">
                    <div class="message-content">
                        <div class="message-text">您好！我是AI数据分析助手，可以帮您分析招聘数据、生成报告或回答相关问题。请问有什么可以帮助您的吗？</div>
                        <div class="message-time">刚刚</div>
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="quick-questions">
                    <button class="quick-btn" onclick="askQuickQuestion('分析候选人整体表现')">分析候选人整体表现</button>
                    <button class="quick-btn" onclick="askQuickQuestion('生成招聘效率报告')">生成招聘效率报告</button>
                    <button class="quick-btn" onclick="askQuickQuestion('对比各职位数据')">对比各职位数据</button>
                </div>
                <div class="report-actions">
                    <button class="report-btn" onclick="generateAndDownloadReport()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        生成完整报告
                    </button>
                    <button class="report-btn email" onclick="showEmailReportModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                        邮件发送报告
                    </button>
                </div>
                <div class="input-container">
                    <input type="text" id="aiChatInput" placeholder="输入您的问题..." onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendAIMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 遮罩层 -->
        <div class="chat-overlay" id="chatOverlay" onclick="toggleAIChat()"></div>

        <!-- 邮件发送模态框 -->
        <div class="email-modal" id="emailModal">
            <div class="email-modal-content">
                <div class="email-header">
                    <h3>发送招聘分析报告</h3>
                    <button class="close-email" onclick="closeEmailModal()">×</button>
                </div>
                <form id="emailReportForm">
                    <div class="form-group">
                        <label for="recipientEmail">收件人邮箱</label>
                        <input type="email" id="recipientEmail" required placeholder="manager@company.com">
                    </div>
                    <div class="form-group">
                        <label for="emailSubject">邮件主题</label>
                        <input type="text" id="emailSubject" value="招聘数据分析报告" required>
                    </div>
                    <div class="form-group">
                        <label for="reportType">报告类型</label>
                        <select id="reportType">
                            <option value="comprehensive">综合分析报告</option>
                            <option value="summary">摘要报告</option>
                            <option value="candidate_analysis">候选人分析</option>
                            <option value="position_comparison">职位对比</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="emailMessage">附加说明</label>
                        <textarea id="emailMessage" rows="3" placeholder="请查收最新的招聘数据分析报告..."></textarea>
                    </div>
                    <div class="email-actions">
                        <button type="button" class="btn-secondary" onclick="closeEmailModal()">取消</button>
                        <button type="submit" class="btn-primary">发送报告</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // 配置PDF.js
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <script src="js/pdf-viewer.js"></script>
    <script src="js/dashboard.js"></script>
    <script>
        // 调试脚本 - 直接更新数据分析页面
        console.log('Inline debug script loaded');
        
        async function debugUpdateAnalytics() {
            try {
                console.log('Fetching analytics data...');
                const response = await fetch('http://localhost:8000/api/dashboard/stats');
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Analytics data:', data);
                    
                    // 直接更新最佳候选人
                    const bestContainer = document.querySelector('.candidates-ranking');
                    if (bestContainer && data.best_candidates) {
                        console.log('Updating best candidates container');
                        bestContainer.innerHTML = data.best_candidates.map((item, index) => `
                            <div style="display: flex; align-items: center; padding: 15px; margin: 10px 0; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="width: 30px; height: 30px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold;">
                                    ${index + 1}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 16px;">${item.candidate.name}</div>
                                    <div style="color: #666; font-size: 14px;">${item.candidate.position}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #28a745;">${item.candidate.score ? item.candidate.score + ' 分' : '未评分'}</div>
                                    <div style="font-size: 12px; color: #666;">${item.candidate.interview_date}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    // 直接更新最低薪资候选人
                    const salaryContainer = document.querySelector('.salary-ranking');
                    if (salaryContainer && data.lowest_salary_candidates) {
                        console.log('Updating salary candidates container');
                        salaryContainer.innerHTML = data.lowest_salary_candidates.map((item, index) => `
                            <div style="display: flex; align-items: center; padding: 15px; margin: 10px 0; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 16px;">${item.candidate.name}</div>
                                    <div style="color: #666; font-size: 14px;">${item.candidate.position}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #dc3545;">${item.candidate.expected_salary}</div>
                                    <div style="font-size: 12px; color: #666;">${item.candidate.score ? '评分: ' + item.candidate.score : '未评分'}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    console.error('Failed to fetch analytics data');
                }
            } catch (error) {
                console.error('Debug update failed:', error);
            }
        }
        
        // 监听标签切换，当切换到analytics时更新数据
        document.addEventListener('DOMContentLoaded', function() {
            // 重写switchTab函数来包含我们的调试更新
            const originalSwitchTab = window.switchTab;
            window.switchTab = function(tabName) {
                if (originalSwitchTab) {
                    originalSwitchTab(tabName);
                }
                if (tabName === 'analytics') {
                    setTimeout(debugUpdateAnalytics, 100); // 延迟一点确保DOM已更新
                }
            };
            
            // 如果当前已经在analytics标签，立即更新
            if (window.currentTab === 'analytics') {
                setTimeout(debugUpdateAnalytics, 500);
            }
        });
    </script>
</body>
</html>