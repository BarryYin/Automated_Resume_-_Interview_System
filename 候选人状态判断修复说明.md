# 候选人状态判断逻辑修复说明

## 问题描述

栾平有评分数据（Knowledge, Skill等维度评分），但显示状态为"待面试"，这是不合理的。

## 问题原因

原来的状态判断逻辑只检查两个字段：
1. "面试总评分"字段
2. "是否已面试（AI）"字段

但是忽略了维度评分（Knowledge, Skill, Ability, Personality, Motivation, Value）。

如果候选人有维度评分但没有填写"面试总评分"字段，就会被错误地判断为"待面试"。

## 修复方案

修改 `backend/excel_data_loader.py` 中的状态判断逻辑，增加对维度评分的检查：

### 修复后的逻辑（优先级从高到低）

```python
# 1. 如果有"面试总评分"，使用总评分，状态为"已完成"
if interview_score and pd.notna(interview_score):
    status = "已完成"
    score = int(float(interview_score))

# 2. 如果有任何维度评分，计算平均分，状态为"已完成" ← 新增
elif dimension_scores:  # dimension_scores = [Knowledge, Skill, Ability, ...]
    status = "已完成"
    score = int(sum(dimension_scores) / len(dimension_scores))

# 3. 如果标记为"已面试"但没有评分，状态为"面试中"
elif is_interviewed == "是":
    status = "面试中"
    score = None

# 4. 其他情况为"待面试"
else:
    status = "待面试"
    score = None
```

## 修复内容

### 1. 增加维度评分收集

```python
# 获取各维度评分
knowledge = self._safe_float(row.get("Knowledge"))
skill = self._safe_float(row.get("Skill"))
ability = self._safe_float(row.get("Ability"))
personality = self._safe_float(row.get("Personality"))
motivation = self._safe_float(row.get("Motivation"))
value = self._safe_float(row.get("Value"))

# 收集所有有效的维度评分
dimension_scores = [s for s in [knowledge, skill, ability, personality, motivation, value] if s is not None]
```

### 2. 修改状态判断逻辑

增加了对 `dimension_scores` 的检查，如果有任何维度评分，就认为候选人已完成面试。

### 3. 保存所有维度评分

```python
candidate = {
    ...
    "knowledge_score": knowledge,
    "skill_score": skill,
    "ability_score": ability,
    "personality_score": personality,
    "motivation_score": motivation,
    "value_score": value,
    ...
}
```

## 测试方法

运行测试脚本：

```bash
python test_candidate_status.py
```

测试脚本会：
1. 加载所有候选人数据
2. 显示每个候选人的状态和评分
3. 统计各状态的数量
4. 特别检查栾平的状态是否正确

## 预期结果

修复后，栾平的状态应该是：
- **状态**: 已完成
- **总分**: 根据维度评分计算的平均分
- **维度评分**: 显示所有有效的维度评分

## 影响范围

这个修复会影响所有候选人的状态判断：

1. **有"面试总评分"的候选人**：不受影响，继续使用总评分
2. **有维度评分但无总评分的候选人**：状态从"待面试"改为"已完成"，显示计算的平均分
3. **标记为"已面试"但无评分的候选人**：不受影响，继续显示"面试中"
4. **其他候选人**：不受影响，继续显示"待面试"

## 验证清单

- [x] 修改状态判断逻辑
- [x] 增加维度评分收集
- [x] 保存所有维度评分到候选人数据
- [x] 创建测试脚本
- [x] 编写修复说明文档

## 后续建议

1. **数据规范化**：建议在Excel中统一使用"面试总评分"字段，或者明确使用维度评分
2. **状态同步**：如果有维度评分，建议同时更新"是否已面试（AI）"字段为"是"
3. **评分计算**：可以考虑为不同维度设置权重，而不是简单平均

## 相关文件

- `backend/excel_data_loader.py` - 主要修复文件
- `test_candidate_status.py` - 测试脚本
- `候选人状态判断修复说明.md` - 本文档
