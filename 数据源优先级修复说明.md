# 数据源优先级修复说明

## 问题描述

系统使用两个数据源：
1. **Excel文件** (candidate.xlsx) - 静态的候选人基础信息
2. **SQLite数据库** - 动态的面试记录和评分

之前的实现只使用Excel数据，导致：
- 栾平在数据库中有面试记录（1个回答，评分20），但显示为"待面试"
- 田忠在数据库中有7个回答（平均分54），但显示Excel中的评分50

## 修复方案

修改 `GET /api/candidates` API，实现**数据库优先**的策略。

### 数据优先级（从高到低）

```
1. 数据库面试记录（最新、最准确）
   ↓
2. Excel评分数据（历史数据）
   ↓
3. 默认状态（待面试）
```

### 状态判断逻辑

```python
if 数据库有面试记录:
    if 回答数 >= 10:
        状态 = "已完成"
        评分 = 数据库平均分
    elif 回答数 > 0:
        状态 = "面试中"
        评分 = 数据库平均分
else:
    if Excel有维度评分:
        状态 = "已完成"
        评分 = Excel评分
    elif Excel标记为"已面试":
        状态 = "面试中"
    else:
        状态 = "待面试"
```

## 修复内容

### 修改的文件
- `backend/main.py` - `get_candidates()` 函数

### 新增的查询逻辑

```python
# 查询数据库中的面试评分
cursor.execute('''
    SELECT 
        isq.session_id,
        COUNT(ia.id) as answer_count,
        AVG(ia.score) as avg_score,
        MAX(ia.created_at) as last_answer_time
    FROM interview_session_questions isq
    LEFT JOIN interview_answers ia ON isq.session_id = ia.session_id
    WHERE isq.candidate_name = ? OR isq.candidate_email = ?
    GROUP BY isq.session_id
    ORDER BY last_answer_time DESC
    LIMIT 1
''', (candidate_name, candidate_email))

# 如果数据库中有面试记录，优先使用数据库的评分和状态
if db_interview and db_interview[1] > 0:
    # 更新状态和评分
    if answer_count >= 10:
        candidate['status'] = '已完成'
        candidate['score'] = int(avg_score)
    elif answer_count > 0:
        candidate['status'] = '面试中'
        candidate['score'] = int(avg_score)
```

## 修复效果

### 修复前
```
姓名    状态      总分    数据源
田忠    已完成     50     Excel（不准确）
栾平    待面试     -      Excel（忽略了数据库数据）
```

### 修复后
```
姓名    状态      总分    数据源      回答数
田忠    面试中     54     数据库      7个回答
栾平    面试中     20     数据库      1个回答
```

## 新增字段

为每个候选人添加了以下字段：
- `db_interview`: boolean - 是否使用数据库数据
- `answer_count`: int - 数据库中的回答数量

## 验证方法

### 方法1: 通过API验证

```bash
curl -s http://localhost:8000/api/candidates | python3 -m json.tool | grep -A 10 '"name": "栾平"'
```

### 方法2: 通过前端验证

1. 打开管理员控制台：`http://localhost:3000/dashboard.html`
2. 切换到"候选人"标签页
3. 查看栾平的状态和评分

### 方法3: 运行测试脚本

```bash
python3 /tmp/check_data_sources.py
```

## 数据一致性保证

### 1. 面试完成后自动更新

当候选人完成面试（回答10个问题）后：
- 数据库自动记录所有回答和评分
- API自动计算平均分
- 状态自动更新为"已完成"

### 2. 数据同步建议

为了保持数据一致性，建议：

1. **主数据源**：使用数据库作为主数据源
2. **Excel作为备份**：Excel仅用于初始导入和备份
3. **定期同步**：可以添加一个功能，将数据库数据导出到Excel

### 3. 未来优化方向

1. **完全迁移到数据库**
   - 将Excel中的所有候选人信息导入数据库
   - 只使用数据库作为唯一数据源

2. **数据导出功能**
   - 支持将数据库数据导出为Excel
   - 方便HR进行离线分析

3. **数据同步机制**
   - 定期将数据库数据同步到Excel
   - 或者提供手动同步按钮

## 影响范围

### 受影响的候选人

1. **有数据库面试记录的候选人**
   - 田忠：状态从"已完成(50分)"改为"面试中(54分)"
   - 栾平：状态从"待面试"改为"面试中(20分)"

2. **只有Excel数据的候选人**
   - 不受影响，继续使用Excel数据

3. **新候选人**
   - 面试后数据自动保存到数据库
   - 自动使用数据库数据

## 总结

✅ **修复完成**：系统现在优先使用数据库中的面试数据
✅ **数据准确**：栾平正确显示为"面试中"，评分20
✅ **逻辑清晰**：数据库 > Excel > 默认状态
✅ **向后兼容**：没有数据库记录的候选人继续使用Excel数据

**栾平的最终状态**：
- 状态：面试中（因为只回答了1个问题，未完成10个问题）
- 评分：20分（数据库中的实际评分）
- 数据源：数据库（最新、最准确）
