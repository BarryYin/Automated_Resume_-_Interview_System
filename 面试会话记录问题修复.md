# 面试会话记录问题修复

## 问题描述

包涵完成面试后，状态显示为"已完成"，但查看会话记录时没有任何对话内容。

## 问题原因

系统有两个面试会话表：

1. **interview_sessions** - 由 `/api/interview/start` 创建
2. **interview_session_questions** - 由 `/api/interview/generate-questions` 创建

### 问题流程

```
包涵登录
  ↓
调用 /api/interview/start
  ↓
创建 interview_sessions 记录 ✓
  ↓
使用预生成的问题（不调用generate-questions）
  ↓
没有创建 interview_session_questions 记录 ✗
  ↓
面试回答提交
  ↓
使用 session_id 保存到 interview_answers 表 ✓
  ↓
查询面试记录
  ↓
只查询 interview_session_questions 表 ✗
  ↓
找不到会话记录 ✗
  ↓
显示"暂无面试记录"
```

### 数据库状态

```sql
-- interview_sessions 表（有记录）
session_id: ec14ec32-13eb-4dac-9172-31b53b4c3468
candidate_id: 2003 (包涵)
created_at: 2025-11-23 00:30:20

-- interview_session_questions 表（无记录）
-- 空

-- interview_answers 表（无记录）
-- 因为 session_id 不在 interview_session_questions 表中
-- get_candidate_name_by_session 返回 None
-- 所以回答没有被保存
```

## 修复方案

### 方案1：统一使用 interview_sessions 表（推荐）

修改相关函数，让它们同时查询两个表。

#### 1. 修改 get_candidate_name_by_session

```python
def get_candidate_name_by_session(session_id):
    """根据会话ID获取候选人姓名"""
    conn = sqlite3.connect('recruitment.db')
    cursor = conn.cursor()
    
    try:
        # 先从interview_session_questions表查询
        cursor.execute('''
            SELECT candidate_name 
            FROM interview_session_questions 
            WHERE session_id = ?
        ''', (session_id,))
        
        result = cursor.fetchone()
        if result:
            return result[0]
        
        # 如果没找到，从interview_sessions表查询
        cursor.execute('''
            SELECT c.name
            FROM interview_sessions isess
            JOIN candidates c ON isess.candidate_id = c.id
            WHERE isess.session_id = ?
        ''', (session_id,))
        
        result = cursor.fetchone()
        return result[0] if result else None
```

#### 2. 修改 get_candidate_interview_records

```python
# 1. 从interview_session_questions表查询
cursor.execute('''
    SELECT session_id, questions_json, strategy, created_at
    FROM interview_session_questions
    WHERE candidate_name = ? OR candidate_email = ?
    ORDER BY created_at DESC
''', (candidate_name, candidate_email))

sessions_with_questions = cursor.fetchall()

# 2. 从interview_sessions表查询
cursor.execute('''
    SELECT isess.session_id, NULL as questions_json, NULL as strategy, isess.created_at
    FROM interview_sessions isess
    JOIN candidates c ON isess.candidate_id = c.id
    WHERE c.name = ? OR c.email = ?
    ORDER BY isess.created_at DESC
''', (candidate_name, candidate_email))

sessions_without_questions = cursor.fetchall()

# 合并并去重
all_sessions = {}
for session in sessions_with_questions:
    all_sessions[session[0]] = session
for session in sessions_without_questions:
    if session[0] not in all_sessions:
        all_sessions[session[0]] = session

sessions = list(all_sessions.values())
```

#### 3. 修改前端逻辑

确保使用预生成问题时也创建会话记录：

```javascript
// 创建面试会话记录（用于保存回答）
const sessionResponse = await fetch('http://localhost:8000/api/interview/start', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        name: session.candidateName,
        email: session.candidateEmail,
        invitation_code: session.invitationCode || '1001'
    })
});

if (sessionResponse.ok) {
    const sessionData = await sessionResponse.json();
    this.sessionId = sessionData.session_id;
    
    // 保存到localStorage
    session.llmSessionId = this.sessionId;
    localStorage.setItem('interviewSession', JSON.stringify(session));
}
```

## 修复后的流程

```
包涵登录
  ↓
使用预生成的问题
  ↓
调用 /api/interview/start 创建会话 ✓
  ↓
创建 interview_sessions 记录 ✓
  ↓
获取 session_id
  ↓
面试回答提交
  ↓
get_candidate_name_by_session 查询两个表 ✓
  ↓
找到候选人姓名 ✓
  ↓
保存回答到 interview_answers 表 ✓
  ↓
查询面试记录
  ↓
查询两个表并合并 ✓
  ↓
找到会话记录 ✓
  ↓
显示对话内容 ✓
```

## 修改的文件

1. **backend/main.py**
   - `get_candidate_name_by_session()` - 查询两个表
   - `get_candidate_interview_records()` - 合并两个表的数据

2. **frontend/js/interview.js**
   - `generateInterviewQuestions()` - 使用预生成问题时也创建会话

## 验证方法

### 1. 检查数据库

```sql
-- 查看包涵的会话记录
SELECT session_id, candidate_id, created_at
FROM interview_sessions
WHERE candidate_id = 2003;

-- 查看包涵的回答记录
SELECT ia.session_id, ia.question_text, ia.answer_text, ia.score
FROM interview_answers ia
JOIN interview_sessions isess ON ia.session_id = isess.session_id
WHERE isess.candidate_id = 2003;
```

### 2. 测试流程

1. 包涵登录并开始面试
2. 回答几个问题
3. 打开浏览器控制台，查看 session_id
4. 在数据库中查询该 session_id 的记录
5. 在候选人详情页查看会话记录

### 3. API测试

```bash
# 获取包涵的面试记录
curl http://localhost:8000/api/candidates/2003/interview-records | python3 -m json.tool
```

应该能看到会话记录和对话内容。

## 数据库表关系

```
candidates (候选人表)
  ↓ (1:N)
interview_sessions (面试会话表)
  ↓ (1:N)
interview_answers (面试回答表)

interview_session_questions (预生成问题的会话表)
  ↓ (1:N)
interview_answers (面试回答表)
```

## 注意事项

1. **两个会话表的区别**：
   - `interview_sessions`: 所有面试会话
   - `interview_session_questions`: 只有调用generate-questions的会话

2. **session_id 的来源**：
   - 使用预生成问题：来自 `interview_sessions`
   - 实时生成问题：来自 `interview_session_questions`

3. **查询策略**：
   - 先查 `interview_session_questions`（有问题信息）
   - 再查 `interview_sessions`（只有会话信息）
   - 合并结果

## 总结

✅ **修复完成**：系统现在能正确处理两种会话类型
✅ **回答保存**：使用预生成问题时回答也能正确保存
✅ **记录查询**：能查询到所有类型的面试记录

**关键改动**：
- `get_candidate_name_by_session` 查询两个表
- `get_candidate_interview_records` 合并两个表的数据
- 前端使用预生成问题时也创建会话记录

现在包涵的面试记录应该能正常显示了！
