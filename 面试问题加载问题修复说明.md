# 面试问题加载问题修复说明

## 问题描述

当候选人（如包涵）登录并开始面试时，面试页面没有使用预生成的AI问题，而是实时生成新问题。

## 问题原因

候选人登录时，会话信息中**缺少 `candidateId` 字段**，导致面试页面无法查询数据库中预生成的问题。

### 数据流程

```
候选人登录
  ↓
保存会话信息到localStorage
  {
    sessionId: "xxx",
    candidateName: "包涵",
    candidateEmail: "xxx@qq.com",
    candidatePosition: "C端产品经理-AIGC领域",
    candidateId: undefined  ← 缺少这个字段！
  }
  ↓
面试页面加载
  ↓
尝试获取 session.candidateId
  ↓
candidateId 为 undefined
  ↓
无法查询预生成的问题
  ↓
实时生成新问题（忽略了管理员预设的问题）
```

## 修复方案

在候选人登录时，通过API查询候选人ID，并保存到会话信息中。

### 修改的文件

`frontend/js/main.js` - 候选人登录逻辑

### 修复内容

```javascript
// 修复前
const sessionData = {
    sessionId: result.session_id,
    candidateName: candidateData.name,
    candidateEmail: candidateData.email,
    candidatePosition: candidatePosition,
    invitationCode: candidateData.invitation_code
    // 缺少 candidateId
};

// 修复后
// 1. 先查询候选人ID
let candidateId = null;
try {
    const candidatesResponse = await fetch(`${API_BASE}/candidates`);
    if (candidatesResponse.ok) {
        const candidates = await candidatesResponse.json();
        const candidate = candidates.find(c => 
            c.name === candidateData.name || c.email === candidateData.email
        );
        if (candidate) {
            candidateId = candidate.id;
        }
    }
} catch (error) {
    console.warn('查询候选人ID失败:', error);
}

// 2. 保存完整的会话信息
const sessionData = {
    sessionId: result.session_id,
    candidateId: candidateId,  // ← 添加候选人ID
    candidateName: candidateData.name,
    candidateEmail: candidateData.email,
    candidatePosition: candidatePosition,
    invitationCode: candidateData.invitation_code
};
```

## 修复后的流程

```
候选人登录
  ↓
调用 /api/interview/start
  ↓
查询 /api/candidates 获取候选人ID
  ↓
保存完整的会话信息
  {
    sessionId: "xxx",
    candidateId: 2003,  ← 有ID了！
    candidateName: "包涵",
    candidateEmail: "422342160@qq.com",
    candidatePosition: "C端产品经理-AIGC领域"
  }
  ↓
面试页面加载
  ↓
获取 session.candidateId = 2003
  ↓
查询 /api/candidates/2003/questions
  ↓
找到预生成的10个问题
  ↓
使用预生成的问题进行面试 ✓
```

## 验证方法

### 方法1: 使用测试页面

1. 打开 `test_interview_flow.html`
2. 点击"包涵"按钮模拟登录
3. 依次执行步骤2、3、4
4. 查看是否成功加载预生成的问题

### 方法2: 实际测试

1. 打开 `frontend/candidate-login.html`
2. 输入：
   - 姓名：包涵
   - 邮箱：422342160@qq.com
3. 点击"开始面试"
4. 在面试页面，打开浏览器控制台
5. 查看日志，应该显示：
   ```
   使用数据库中保存的面试问题
   成功获取 10 个问题
   ```

### 方法3: 检查localStorage

在浏览器控制台执行：
```javascript
JSON.parse(localStorage.getItem('interviewSession'))
```

应该看到：
```json
{
  "sessionId": "...",
  "candidateId": 2003,  ← 应该有这个字段
  "candidateName": "包涵",
  "candidateEmail": "422342160@qq.com",
  "candidatePosition": "C端产品经理-AIGC领域"
}
```

## 候选人ID对照表

| 姓名 | ID | 邮箱 | 有预生成问题 |
|------|-----|------|-------------|
| 田忠 | 2001 | 422342158@qq.com | 是 (10个) |
| 龙小天 | 2002 | 422342159@qq.com | 是 (10个) |
| 包涵 | 2003 | 422342160@qq.com | 是 (10个) |
| 栾平 | 2004 | 422342161@qq.com | 是 (10个) |
| 高飞虎 | 2005 | 422342162@qq.com | 是 (10个) |
| 乔志天 | 2006 | 422342163@qq.com | 是 (10个) |

## 面试页面的问题加载逻辑

`frontend/js/interview.js` 中的逻辑：

```javascript
async generateInterviewQuestions() {
    const session = JSON.parse(localStorage.getItem('interviewSession'));
    const candidateId = session.candidateId;  // ← 需要这个字段
    
    if (candidateId) {
        // 尝试从数据库加载预生成的问题
        const response = await fetch(`/api/candidates/${candidateId}/questions`);
        const data = await response.json();
        
        if (data.has_questions && data.questions.length > 0) {
            // 使用预生成的问题
            this.questions = data.questions;
            console.log('使用数据库中保存的面试问题');
            return;
        }
    }
    
    // 如果没有预生成的问题，实时生成
    // ...
}
```

## 影响范围

### 修复前
- ❌ 所有候选人面试时都会实时生成新问题
- ❌ 管理员预设的问题被忽略
- ❌ 每次面试的问题都不一样

### 修复后
- ✅ 有预生成问题的候选人使用预设问题
- ✅ 管理员的问题调整会被使用
- ✅ 面试问题保持一致性

## 相关功能

这个修复确保了以下功能正常工作：

1. **管理员预生成问题** - 在候选人列表中为候选人生成问题
2. **管理员调整问题** - 根据反馈重新生成问题
3. **候选人面试** - 使用管理员预设的问题进行面试

## 总结

✅ **修复完成**：候选人登录时会查询并保存候选人ID
✅ **问题加载**：面试页面能正确加载预生成的问题
✅ **功能完整**：管理员预设的问题会被使用

现在包涵登录后，会使用管理员为她预生成的10个C端产品经理相关的问题进行面试！
